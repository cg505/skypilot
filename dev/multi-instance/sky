#!/bin/bash
# Wrapper that runs sky commands inside the isolated Docker container.
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

check_docker
load_instance

# Start container if not running
if ! container_running; then
    "$SCRIPT_DIR/start-container"
fi

# Determine TTY flags
DOCKER_FLAGS="-i"
if [[ -t 0 ]] && [[ -t 1 ]]; then
    DOCKER_FLAGS="-it"
fi

# Pass through relevant environment variables by prefix
ENV_ARGS=""
for var in $(compgen -v | grep -E '^(SKYPILOT_|SKY_|AWS_|AZURE_|GOOGLE_|GCP_|OCI_|KUBE|KUBERNETES_|RUNPOD_|HYPERBOLIC_|SEEWEB_|LAMBDA_|DOCKER_|GIT_|HTTP_PROXY|HTTPS_PROXY|NO_PROXY|RAY_|HELM_)'); do
    ENV_ARGS="$ENV_ARGS -e $var=${!var}"
done

# For 'api start', bind to 0.0.0.0 so port forwarding works
if [[ "${1:-}" == "api" ]] && [[ "${2:-}" == "start" ]]; then
    exec docker exec $DOCKER_FLAGS $ENV_ARGS "$CONTAINER_NAME" \
        /opt/skypilot-venv/bin/sky "$@" --host 0.0.0.0
fi

# For other commands, ensure API server is running with correct binding first
# (prevents auto-start from binding to 127.0.0.1 which breaks port forwarding)
if [[ "${1:-}" != "api" ]]; then
    if ! docker exec "$CONTAINER_NAME" curl -s http://0.0.0.0:46580/api/health &>/dev/null; then
        docker exec "$CONTAINER_NAME" /opt/skypilot-venv/bin/sky api start --host 0.0.0.0 &>/dev/null || true
    fi
fi

exec docker exec $DOCKER_FLAGS $ENV_ARGS "$CONTAINER_NAME" \
    /opt/skypilot-venv/bin/sky "$@"
