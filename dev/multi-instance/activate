# Activate the multi-instance sky wrapper.
# Source this file: source /path/to/skypilot/dev/multi-instance/activate
#
# Run 'deactivate-sky' to undo.

# Prevent double activation
if [[ -n "${_SKY_WRAPPER_ACTIVE:-}" ]]; then
    echo "Sky wrapper already active. Run 'deactivate-sky' first."
    return 0
fi

# Find script directory (works in both bash and zsh)
if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
    _SKY_WRAPPER_DIR="${BASH_SOURCE[0]%/*}"
    [[ "$_SKY_WRAPPER_DIR" == "${BASH_SOURCE[0]}" ]] && _SKY_WRAPPER_DIR="."
else
    # zsh
    _SKY_WRAPPER_DIR="${0:a:h}"
fi
_SKY_WRAPPER_DIR="$(cd "$_SKY_WRAPPER_DIR" && pwd)"

# Auto-run setup if needed
if ! "$_SKY_WRAPPER_DIR/setup.sh"; then
    return 1
fi

# Save original state
_SKY_ORIG_PS1="${PS1:-}"
_SKY_ORIG_PATH="$PATH"

# Prepend wrapper directory to PATH (persists to child processes)
export PATH="$_SKY_WRAPPER_DIR:$PATH"

# Modify prompt
PS1="(sky-dev) ${PS1:-}"

# Mark as active
export _SKY_WRAPPER_ACTIVE=1
export _SKY_WRAPPER_DIR

# Deactivate function
deactivate-sky() {
    PATH="$_SKY_ORIG_PATH"
    PS1="${_SKY_ORIG_PS1:-}"
    unset _SKY_WRAPPER_ACTIVE _SKY_WRAPPER_DIR _SKY_ORIG_PS1 _SKY_ORIG_PATH
    unset -f deactivate-sky
    echo "Deactivated."
}

echo "Activated. Run 'deactivate-sky' to disable."
